<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>

    <!-- Import Capacitor Storage -->
    <script>
        window.Storage = Capacitor.Plugins.Preferences;
    </script>

    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding-bottom: 80px;
        }
        .container {
          padding: 20px;
        }
        .ort-container {
          margin-bottom: 20px;
        }
        .barcode-container input {
          width: 100%;
          font-size: 24px;
          padding: 10px;
        }
        .scanned-list {
          margin-top: 20px;
        }
        .scanned-list li {
          margin: 8px 0;
        }
        .actions {
          text-align: center;
          margin-top: 30px;
        }
        .ok-button {
          width: 250px;
          height: 250px;
          font-size: 50px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 50%;
          cursor: pointer;
        }
        .cancel-button {
          margin-top: 20px;
          background-color: #f44336;
          color: white;
          font-size: 18px;
          border: none;
          padding: 10px 20px;
          cursor: pointer;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="ort-container">
        <label for="ortInput"><strong>Ort / Messe:</strong></label>
        <input type="text" id="ortInput" placeholder="z.â€¯B. Dokomi">
    </div>

    <div class="barcode-container">
        <input type="text" id="barcodeInput" placeholder="Barcode eingeben und Enter drÃ¼cken...">
    </div>

    <ul id="scannedList" class="scanned-list"></ul>
    <p><strong>Gesamtsumme:</strong> <span id="totalPrice">0.00</span> â‚¬</p>

    <div class="actions">
        <button class="ok-button" id="okButton">OK</button><br>
        <button class="cancel-button" id="cancelButton">Abbrechen</button>
    </div>
</div>

<script>
    let scannedItems = {};

    async function saveOrt() {
      const ort = document.getElementById("ortInput").value;
      await Storage.set({ key: "messeOrt", value: ort });
    }
    window.saveOrt = saveOrt;

    async function loadOrt() {
      const { value } = await Storage.get({ key: "messeOrt" });
      if (value) {
        document.getElementById("ortInput").value = value;
      }
    }
    window.loadOrt = loadOrt;

    async function checkBarcode(event) {
  console.log("ðŸ§© checkBarcode() aufgerufen");

  if (event.key === "Enter") {
    console.log("âœ… Enter gedrÃ¼ckt!");

    const barcodeInputField = event.target;
    const barcode = barcodeInputField.value.trim().toLowerCase();
    console.log("ðŸ” Eingegebener Barcode:", barcode);

    if (!barcode) {
      console.warn("âš ï¸ Kein Barcode eingegeben.");
      return;
    }

    const { value } = await Storage.get({ key: "inventar" });
    const inventar = JSON.parse(value || "[]");

    console.log("ðŸ“¦ Inventar geladen:", inventar);

    const artikel = inventar.find(a => (a.barcode || "").toLowerCase() === barcode);

    if (!artikel) {
      console.error("ðŸš« Kein Artikel mit diesem Barcode gefunden!");
      alert("âš ï¸ Kein Artikel mit diesem Barcode gefunden!");
      return;
    }

    console.log("âœ… Artikel gefunden:", artikel);

    if (scannedItems[barcode]) {
      scannedItems[barcode].menge++;
      console.log(`ðŸ” Menge von ${artikel.item} erhÃ¶ht auf ${scannedItems[barcode].menge}`);
    } else {
      scannedItems[barcode] = {
        name: artikel.item,
        menge: 1,
        preis: artikel.preis,
        kategorie: artikel.kategorie
      };
      console.log(`ðŸ†• Artikel ${artikel.item} neu hinzugefÃ¼gt`);
    }

    updateScannedList();
    barcodeInputField.value = "";
  }
}
window.checkBarcode = checkBarcode;


    function updateScannedList() {
      const list = document.getElementById("scannedList");
      list.innerHTML = "";
      let total = 0;

      Object.entries(scannedItems).forEach(([barcode, data]) => {
        const li = document.createElement("li");
        const gesamt = data.menge * data.preis;
        total += gesamt;
        li.textContent = `${data.name} â€“ Menge: ${data.menge} â€“ Gesamt: ${gesamt.toFixed(2)} â‚¬`;
        list.appendChild(li);
      });

      document.getElementById("totalPrice").textContent = total.toFixed(2);
    }
    window.updateScannedList = updateScannedList;

    async function submitBestellung() {
      const ort = document.getElementById("ortInput").value.trim();
      if (!ort) {
        alert("Bitte gib den Ort der Messe ein.");
        return;
      }

      if (Object.keys(scannedItems).length === 0) {
        alert("Es wurden keine Artikel gescannt.");
        return;
      }

      const datum = new Date().toISOString();
      const { value: bestellungenValue } = await Storage.get({ key: "bestellungen" });
      const bestellungen = JSON.parse(bestellungenValue || "[]");

      const neueBestellung = {
        id: bestellungen.length + 1,
        ort: ort,
        datum: datum,
        artikel: Object.values(scannedItems).map(item => ({
          name: item.name,
          menge: item.menge,
          preis: item.preis,
          kategorie: item.kategorie
        }))
      };

      bestellungen.push(neueBestellung);
      await Storage.set({ key: "bestellungen", value: JSON.stringify(bestellungen) });

      // Bestand im Inventar anpassen
      const { value: inventarValue } = await Storage.get({ key: "inventar" });
      let inventar = JSON.parse(inventarValue || "[]");

      Object.entries(scannedItems).forEach(([barcode, data]) => {
        const item = inventar.find(i => (i.barcode || "").toLowerCase() === barcode);
        if (item) {
          item.anzahl = Math.max(0, item.anzahl - data.menge);
        }
      });

      await Storage.set({ key: "inventar", value: JSON.stringify(inventar) });

      alert("âœ… Bestellung gespeichert & Bestand aktualisiert.");
      scannedItems = {};
      updateScannedList();
    }
    window.submitBestellung = submitBestellung;

    function cancel() {
      if (confirm("Einkauf abbrechen und alles zurÃ¼cksetzen?")) {
        scannedItems = {};
        updateScannedList();
        document.getElementById("barcodeInput").value = "";
      }
    }
    window.cancel = cancel;

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("ðŸ“‹ DOM vollstÃ¤ndig geladen â€“ EventListener aktivieren");
      await loadOrt();

      document.getElementById("barcodeInput").addEventListener("keyup", checkBarcode);
      document.getElementById("ortInput").addEventListener("input", saveOrt);
      document.getElementById("okButton").addEventListener("click", submitBestellung);
      document.getElementById("cancelButton").addEventListener("click", cancel);
    });
</script>

<!-- Navigation -->
<script src="navigation.js"></script>

</body>
</html>
